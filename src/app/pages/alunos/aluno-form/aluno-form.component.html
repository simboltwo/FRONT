<div class="page-header-container bg-brand-blue">
  <h2 class="page-header-title">
    {{ isEditMode ? 'EDIÇÃO DE ALUNO' : 'NOVO ALUNO' }}
  </h2>
  <p class="page-header-desc">
    Siga as etapas para preencher o perfil completo do aluno.
  </p>
</div>

<div class="page-container">
  <div class="wizard-container">
    <div class="card">
      <div class="card-body" *ngIf="!isLoading">

        <div class="stepper-bar-modern">
          <div class="stepper-item" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
            <div class="stepper-icon">
              <i class="bi bi-person-badge"></i>
            </div>
            <div class="stepper-label">
              <span>Etapa 1</span>
              Pessoais
            </div>
          </div>
          <div class="stepper-line" [class.completed]="currentStep > 1"></div>
          <div class="stepper-item" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
            <div class="stepper-icon">
              <i class="bi bi-mortarboard"></i>
            </div>
            <div class="stepper-label">
              <span>Etapa 2</span>
              Acadêmicos
            </div>
          </div>
          <div class="stepper-line" [class.completed]="currentStep > 2"></div>
          <div class="stepper-item" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
            <div class="stepper-icon">
              <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="stepper-label">
              <span>Etapa 3</span>
              Infos. NAAPI
            </div>
          </div>
        </div>

        <div *ngIf="errorMessage" class="alert alert-danger">
          {{ errorMessage }}
        </div>

        <form [formGroup]="mainForm" (ngSubmit)="onSubmit()">

          <div *ngIf="currentStep === 1" formGroupName="dadosPessoais" class="form-step-content animate-fadeInUp">
            <div class="row g-4">
              <div class="col-md-4">
                <div class="form-section-card">
                  <div class="form-section-header">
                    <i class="bi bi-camera-fill"></i>
                    <h6>Foto de Perfil</h6>
                  </div>
                  <div class="form-section-body">
                    <div class="file-upload-quadrant" [class.has-preview]="previewUrl || currentFotoUrl">
                      <img *ngIf="!previewUrl && currentFotoUrl" [src]="currentFotoUrl" alt="Foto Atual" class="preview-img">
                      <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="preview-img">
                      <label for="fotoFile" class="file-upload-label">
                        <i class="bi bi-upload"></i>
                        <span class="label-text">{{ (previewUrl || currentFotoUrl) ? 'Alterar Foto' : 'Anexar Foto' }}</span>
                      </label>
                      <input type="file" id="fotoFile" class="form-control" (change)="onFileChange($event)" accept="image/png, image/jpeg">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-8">
                <div class="form-section-card">
                  <div class="form-section-header">
                    <i class="bi bi-person-lines-fill"></i>
                    <h6>Identificação</h6>
                  </div>
                  <div class="form-section-body">
                    <div class="mb-4">
                      <label for="nome" class="form-label">Nome Completo *</label>
                      <input type="text" class="form-control" id="nome" formControlName="nome"
                             [class.is-invalid]="dadosPessoais.get('nome')!.invalid && dadosPessoais.get('nome')!.touched">
                    </div>
                    <div class="mb-4">
                      <label for="nomeSocial" class="form-label">Nome Social (Opcional)</label>
                      <input type="text" class="form-control" id="nomeSocial" formControlName="nomeSocial">
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-4">
                        <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                        <input type="date" class="form-control" id="dataNascimento" formControlName="dataNascimento">
                      </div>
                      <div class="col-md-6 mb-4">
                        <label for="cpf" class="form-label">CPF</label>
                        <input type="text" class="form-control" id="cpf" formControlName="cpf" placeholder="000.000.000-00">
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="telefoneEstudante" class="form-label">Telefone (Estudante)</label>
                      <input type="tel" class="form-control" id="telefoneEstudante" formControlName="telefoneEstudante">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="currentStep === 2" formGroupName="dadosAcademicos" class="form-step-content animate-fadeInUp">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="form-section-card">
                  <div class="form-section-header">
                    <i class="bi bi-journal-album"></i>
                    <h6>Matrícula e Curso</h6>
                  </div>
                  <div class="form-section-body">
                    <div class="mb-4">
                      <label for="matricula" class="form-label">Matrícula *</label>
                      <input type="text" class="form-control" id="matricula" formControlName="matricula"
                             [class.is-invalid]="dadosAcademicos.get('matricula')!.invalid && dadosAcademicos.get('matricula')!.touched">
                    </div>
                    <div class="mb-4">
                      <label for="cursoId" class="form-label">Curso *</label>
                      <select id="cursoId" class="form-select" formControlName="cursoId"
                              [class.is-invalid]="dadosAcademicos.get('cursoId')!.invalid && dadosAcademicos.get('cursoId')!.touched">
                        <option [ngValue]="null" disabled>Selecione...</option>
                        <option *ngFor="let curso of (cursos$ | async)" [ngValue]="curso.id">{{ curso.nome }}</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="turmaId" class="form-label">Turma *</label>
                      <select id="turmaId" class="form-select" formControlName="turmaId"
                              [class.is-invalid]="dadosAcademicos.get('turmaId')!.invalid && dadosAcademicos.get('turmaId')!.touched">
                        <option [ngValue]="null" disabled>Selecione...</option>
                        <option *ngFor="let turma of (turmas$ | async)" [ngValue]="turma.id">{{ turma.nome }}</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-section-card">
                  <div class="form-section-header">
                    <i class="bi bi-toggles"></i>
                    <h6>Configurações de Apoio</h6>
                  </div>
                  <div class="form-section-body">
                    <div class="mb-4">
                      <label class="form-label">Prioridade de Atendimento *</label>
                      <select class="form-select" formControlName="prioridade">
                        <option value="Baixa">Baixa</option>
                        <option value="Média">Média</option>
                        <option value="Alta">Alta</option>
                      </select>
                    </div>
                    <div class="mb-4">
                      <label class="form-label">Prova em espaço separado? *</label>
                      <div class="d-flex gap-3 pt-2">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="provaSim" [value]="true" formControlName="provaOutroEspaco">
                          <label class="form-check-label" for="provaSim">Sim</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="provaNao" [value]="false" formControlName="provaOutroEspaco">
                          <label class="form-check-label" for="provaNao">Não</label>
                        </div>
                      </div>
                    </div>
                     <div class="mb-3">
                        <label for="processoSipac" class="form-label">Nº Processo Sipac</label>
                        <input type="text" class="form-control" id="processoSipac" formControlName="processoSipac">
                     </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="currentStep === 3" formGroupName="dadosNaapi" class="form-step-content animate-fadeInUp">
            <div class="row g-4">
              <div class="col-12">
                <div class="form-section-card">
                  <div class="form-section-header">
                    <i class="bi bi-clipboard2-pulse-fill"></i>
                    <h6>Diagnósticos e Observações</h6>
                  </div>
                  <div class="form-section-body">

                    <label class="form-label" for="diag-search">Diagnósticos Associados</label>
                    <div class="diagnostico-search-wrapper">
                      <i class="bi bi-search"></i>
                      <input type="text" id="diag-search" class="form-control" [formControl]="diagnosticoSearch" placeholder="Buscar diagnóstico (ex: TDAH, Autismo...)">
                    </div>

                    <div class="diagnosticos-container">
                      <div *ngIf="(filteredDiagnosticos$ | async) as diagnosticos">
                        <div *ngFor="let diag of diagnosticos" class="form-check">
                          <input class="form-check-input" type="checkbox"
                                 [value]="diag.id"
                                 [id]="'diag-' + diag.id"
                                 [checked]="isChecked(diag.id)"
                                 (change)="onDiagnosticoChange($event)">
                          <label class="form-check-label" [for]="'diag-' + diag.id">
                            {{ diag.sigla ? diag.sigla + ' - ' : '' }} {{ diag.nome }}
                          </label>
                        </div>
                        <div *ngIf="diagnosticos.length === 0" class="text-center text-muted p-3 small">
                          Nenhum diagnóstico encontrado para "{{ diagnosticoSearch.value }}".
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-section-card">
                  <div class="form-section-header">
                     <i class="bi bi-journal-text"></i>
                     <h6>Observações Internas (NAAPI)</h6>
                  </div>
                  <div class="form-section-body">
                    <div class="mb-4">
                      <label for="adaptacoes" class="form-label">Adaptações Necessárias</label>
                      <textarea class="form-control" id="adaptacoes" rows="3" formControlName="adaptacoesNecessarias" placeholder="Descreva adaptações pedagógicas, de infraestrutura, etc..."></textarea>
                    </div>
                    <div class="mb-4">
                      <label for="necessidades" class="form-label">Necessidades (Baseadas em Relatórios Médicos)</label>
                      <textarea class="form-control" id="necessidades" rows="3" formControlName="necessidadesRelatoriosMedicos" placeholder="Resumo das necessidades indicadas em laudos..."></textarea>
                    </div>
                    <div class="mb-3">
                      <label for="anotacoes" class="form-label">Anotações Gerais (Uso Interno)</label>
                      <textarea class="form-control" id="anotacoes" rows="3" formControlName="anotacoesNaapi" placeholder="Observações gerais sobre o acompanhamento..."></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card-footer d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-outline-secondary" (click)="cancel()">
              Cancelar
            </button>

            <div>
              <button type="button" class="btn btn-outline-primary me-2" *ngIf="currentStep > 1" (click)="prevStep()">
                Voltar
              </button>
              <button type="button" class="btn btn-primary"
                      *ngIf="currentStep === 1" (click)="nextStep()"
                      [disabled]="dadosPessoais.invalid">
                Próximo <i class="bi bi-arrow-right-short"></i>
              </button>
              <button type="button" class="btn btn-primary"
                      *ngIf="currentStep === 2" (click)="nextStep()"
                      [disabled]="dadosAcademicos.invalid">
                Próximo <i class="bi bi-arrow-right-short"></i>
              </button>
              <button type="submit" class="btn btn-primary"
                      [disabled]="dadosNaapi.invalid || isLoading"
                      *ngIf="currentStep === 3">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ isEditMode ? 'Salvar Alterações' : 'Concluir Cadastro' }}
              </button>
            </div>
          </div>
        </form>
      </div>

      <div *ngIf="isLoading" class="card-body text-center p-5">
         <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Carregando...</span>
          </div>
      </div>

    </div>
  </div>
</div>
