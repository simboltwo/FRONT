<div class="form-page-container">
<div class="wizard-container">

  <div class="card">
    <div class="card-header">
      <h4 class="mb-0">
        {{ isEditMode ? 'Editar Aluno' : 'Novo Aluno' }}
      </h4>
    </div>

    <div class="card-body" *ngIf="!isLoading">

      <div class="stepper-bar">
        <div class="stepper-item" [class.active]="currentStep >= 1">
          <i class="bi bi-person-badge"></i>
          <span class="stepper-label">Dados Pessoais</span>
        </div>
        <div class="stepper-line" [class.completed]="currentStep > 1"></div>
        <div class="stepper-item" [class.active]="currentStep >= 2">
          <i class="bi bi-mortarboard"></i>
          <span class="stepper-label">Académicos</span>
        </div>
        <div class="stepper-line" [class.completed]="currentStep > 2"></div>
        <div class="stepper-item" [class.active]="currentStep >= 3">
          <i class="bi bi-heart-pulse"></i>
          <span class="stepper-label">Infos. NAAPI</span>
        </div>
      </div>

      <div *ngIf="errorMessage" class="alert alert-danger">
        {{ errorMessage }}
      </div>

      <form [formGroup]="mainForm" (ngSubmit)="onSubmit()">

        <div *ngIf="currentStep === 1" formGroupName="dadosPessoais" class="form-step-content animate-fadeInUp">

          <div class="row">
            <div class="col-md-3 text-center mb-3">
              <label class="form-label">Foto de Perfil</label>
              <div class="file-upload-quadrant">

                <div *ngIf="!previewUrl" class="default-icon">
                  <i class="bi bi-person-bounding-box"></i>
                </div>

                <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="preview-img">

                <label for="fotoFile" class="file-upload-label">
                  <i class="bi bi-camera"></i>
                  <span class="label-text">Alterar Foto</span>
                </label>
                <input type="file" id="fotoFile"
                       (change)="onFileChange($event)"
                       accept="image/png, image/jpeg">
              </div>
            </div>

            <div class="col-md-9">
              <div class="row">
                <div class="col-md-6 mb-4">
                  <label for="nome" class="form-label">Nome Completo *</label>
                  <input type="text" class="form-control" id="nome" formControlName="nome"
                         placeholder="Digite o nome completo"
                         [class.is-invalid]="dadosPessoais.get('nome')!.invalid && dadosPessoais.get('nome')!.touched">
                </div>
                <div class="col-md-6 mb-4">
                  <label for="nomeSocial" class="form-label">Nome Social</label>
                  <input type="text" class="form-control" id="nomeSocial" formControlName="nomeSocial"
                         placeholder="Nome que prefere ser chamado">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-4">
                  <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                  <input type="date" class="form-control" id="dataNascimento" formControlName="dataNascimento">
                </div>
                <div class="col-md-6 mb-4">
                  <label for="cpf" class="form-label">CPF</label>
                  <input type="text" class="form-control" id="cpf" formControlName="cpf" placeholder="000.000.000-00">
                </div>
              </div>
              <div class="col-12 mb-4">
                <label for="telefoneEstudante" class="form-label">Telefone (Estudante)</label>
                <input type="tel" class="form-control" id="telefoneEstudante" formControlName="telefoneEstudante"
                         placeholder="(31) 90000-0000">
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="currentStep === 2" formGroupName="dadosAcademicos" class="form-step-content animate-fadeInUp">
          <div class="row">
             <div class="col-md-6 mb-4">
                <label for="matricula" class="form-label">Matrícula *</label>
                <input type="text" class="form-control" id="matricula" formControlName="matricula"
                       placeholder="Ex: 202300001"
                       [class.is-invalid]="dadosAcademicos.get('matricula')!.invalid && dadosAcademicos.get('matricula')!.touched">
             </div>
             <div class="col-md-6 mb-4">
                <label for="processoSipac" class="form-label">Nº Processo Sipac</label>
                <input type="text" class="form-control" id="processoSipac" formControlName="processoSipac"
                       placeholder="Ex: 23062.000111/2023-01">
             </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-4">
              <label for="cursoId" class="form-label">Curso *</label>
              <select id="cursoId" class="form-select" formControlName="cursoId"
                      [class.is-invalid]="dadosAcademicos.get('cursoId')!.invalid && dadosAcademicos.get('cursoId')!.touched">
                <option [ngValue]="null" disabled>Selecione um curso...</option>
                <option *ngFor="let curso of (cursos$ | async)" [ngValue]="curso.id">{{ curso.nome }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-4">
              <label for="turmaId" class="form-label">Turma *</label>
              <select id="turmaId" class="form-select" formControlName="turmaId"
                      [class.is-invalid]="dadosAcademicos.get('turmaId')!.invalid && dadosAcademicos.get('turmaId')!.touched">
                <option [ngValue]="null" disabled>Selecione uma turma...</option>
                <option *ngFor="let turma of (turmas$ | async)" [ngValue]="turma.id">{{ turma.nome }}</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label">Prioridade de Atendimento</label>
              <select class="form-select" formControlName="prioridade">
                <option value="Baixa">Baixa</option>
                <option value="Média">Média</option>
                <option value="Alta">Alta</option>
              </select>
            </div>
            <div class="col-md-6 mb-4">
              <label class="form-label">Prova em espaço separado?</label>
              <div class="d-flex gap-3 pt-2">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="provaSim" [value]="true" formControlName="provaOutroEspaco">
                  <label class="form-check-label" for="provaSim">Sim</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="provaNao" [value]="false" formControlName="provaOutroEspaco">
                  <label class="form-check-label" for="provaNao">Não</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="currentStep === 3" formGroupName="dadosNaapi" class="form-step-content animate-fadeInUp">
          <div class="mb-4">
            <label class="form-label">Diagnósticos</label>
            <div class="diagnosticos-container">
              <div class="diagnosticos-grid-container">
                <div *ngFor="let diag of (diagnosticos$ | async)" class="form-check">
                  <input class="form-check-input" type="checkbox"
                         [value]="diag.id"
                         [id]="'diag-' + diag.id"
                         [checked]="isChecked(diag.id)"
                         (change)="onDiagnosticoChange($event)">
                  <label class="form-check-label" [for]="'diag-' + diag.id">
                    {{ diag.sigla ? diag.sigla : diag.nome }}
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-4">
            <label for="adaptacoes" class="form-label">Adaptações Necessárias</label>
            <textarea class="form-control" id="adaptacoes" rows="3" formControlName="adaptacoesNecessarias"
                      placeholder="Ex: Prova com fonte ampliada, maior tempo de prova..."></textarea>
          </div>
          <div class="mb-4">
            <label for="necessidades" class="form-label">Necessidades (Relatórios Médicos)</label>
            <textarea class="form-control" id="necessidades" rows="3" formControlName="necessidadesRelatoriosMedicos"
                      placeholder="Resumo do que é descrito nos relatórios médicos..."></textarea>
          </div>
          <div class="mb-4">
            <label for="anotacoes" class="form-label">Anotações Gerais (NAAPI)</label>
            <textarea class="form-control" id="anotacoes" rows="3" formControlName="anotacoesNaapi"
                      placeholder="Anotações internas da equipa NAAPI..."></textarea>
          </div>
        </div>

        <div class="card-footer d-flex justify-content-between align-items-center">
          <button type="button" class="btn btn-outline-secondary" (click)="cancel()">
            Cancelar
          </button>

          <div>
            <button type="button" class="btn btn-outline-primary me-2" *ngIf="currentStep > 1" (click)="prevStep()">
              <i class="bi bi-chevron-left me-1"></i>
              Voltar
            </button>
            <button type="button" class="btn btn-primary"
                    *ngIf="currentStep === 1" (click)="nextStep()"
                    [disabled]="dadosPessoais.invalid">

              Próximo
              <i class="bi bi-chevron-right me-1"></i>
            </button>
            <button type="button" class="btn btn-primary"
                    *ngIf="currentStep === 2" (click)="nextStep()"
                    [disabled]="dadosAcademicos.invalid">

              Próximo
              <i class="bi bi-chevron-right me-1"></i>
            </button>
            <button type="submit" class="btn btn-primary"
                    [disabled]="dadosNaapi.invalid || isLoading"
                    *ngIf="currentStep === 3">
              {{ isEditMode ? 'Salvar' : 'Cadastrar' }}
            </button>
          </div>
        </div>

      </form>
    </div>

    <div *ngIf="isLoading" class="card-body text-center p-5">
       <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

  </div>
</div>
</div>
