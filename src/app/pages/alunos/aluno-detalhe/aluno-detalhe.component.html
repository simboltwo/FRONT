<ng-template #loading>
  <div class="d-flex justify-content-center mt-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Carregando dados do aluno...</span>
    </div>
  </div>
</ng-template>

<div class="aluno-detalhe-page" *ngIf="aluno; else loading">
  <div class="row g-0">

    <div class="col-lg-5">
      <div class="aluno-foto-wrapper">
        <img [src]="aluno.foto || 'https://via.placeholder.com/600x800.png?text=FOTO DO ALUNO'"
             alt="Foto do Aluno"
             class="aluno-foto-principal">
        </div>
    </div>

    <div class="col-lg-7">
      <div class="aluno-info-container">

        <nav aria-label="breadcrumb" class="breadcrumb-container">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a routerLink="/alunos">Alunos</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ aluno.nome | slice:0:30 }}{{ aluno.nome.length > 30 ? '...' : '' }}</li>
          </ol>
        </nav>

        <div class="info-section">
          <h2 class="aluno-nome">{{ aluno.nome }}</h2>
          <p *ngIf="aluno.nomeSocial" class="aluno-nome-social">({{ aluno.nomeSocial }})</p>
          <p class="aluno-matricula">{{ aluno.matricula }} | {{ aluno.curso.nome }}</p>
        </div>

        <div class="info-section">
          <ul class="dados-list">
            <li *ngIf="aluno.dataNascimento">
              <span class="label">Data Nasc.</span>
              <span class="value">{{ aluno.dataNascimento | date: 'dd/MM/yyyy' }}</span>
            </li>
            <li *ngIf="aluno.cpf">
              <span class="label">CPF</span>
              <span class="value">{{ aluno.cpf }}</span>
            </li>
            <li *ngIf="aluno.telefoneEstudante">
              <span class="label">Telefone</span>
              <span class="value">{{ aluno.telefoneEstudante }}</span>
            </li>
            <li *ngIf="aluno.turma">
              <span class="label">Turma</span>
              <span class="value">{{ aluno.turma.nome }}</span>
            </li>
            <li *ngIf="aluno.processoSipac">
              <span class="label">Proc. SIPAC</span>
              <span class="value">{{ aluno.processoSipac }}</span>
            </li>
          </ul>
        </div>
        <div class="info-section">
          <label class="form-label-hering">Prioridade</label>
          <div class="swatch-group">
            <button
              class="swatch-color swatch-danger"
              [class.active]="aluno.prioridade === 'Alta'"
              (click)="updateAlunoField('prioridade', 'Alta')"
              title="Prioridade Alta">
              <span>Alta</span>
            </button>
            <button
              class="swatch-color swatch-warning"
              [class.active]="aluno.prioridade === 'Média'"
              (click)="updateAlunoField('prioridade', 'Média')"
              title="Prioridade Média">
              <span>Média</span>
            </button>
            <button
              class="swatch-color swatch-success"
              [class.active]="aluno.prioridade === 'Baixa'"
              (click)="updateAlunoField('prioridade', 'Baixa')"
              title="Prioridade Baixa">
              <span>Baixa</span>
            </button>
          </div>
        </div>

        <div class="info-section">
          <label class="form-label-hering">Prova em Espaço Separado</label>
          <div class="swatch-group">
            <button
              class="swatch-size"
              [class.active]="aluno.provaOutroEspaco === true"
              (click)="updateAlunoField('provaOutroEspaco', true)">
              Sim
            </button>
            <button
              class="swatch-size"
              [class.active]="aluno.provaOutroEspaco === false"
              (click)="updateAlunoField('provaOutroEspaco', false)">
              Não
            </button>
          </div>
        </div>

        <hr class="section-divider">

        <div class="accordion accordion-flush hering-accordion" id="naapiAccordion">

          <div class="accordion-item" *ngIf="aluno.adaptacoesNecessarias && aluno.adaptacoesNecessarias.trim() !== ''">
            <h2 class="accordion-header" id="headingAdaptacoes">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdaptacoes" aria-expanded="false" aria-controls="collapseAdaptacoes">
                Adaptações Necessárias
              </button>
            </h2>
            <div id="collapseAdaptacoes" class="accordion-collapse collapse" aria-labelledby="headingAdaptacoes" data-bs-parent="#naapiAccordion">
              <div class="accordion-body info-content">
                {{ aluno.adaptacoesNecessarias }}
              </div>
            </div>
          </div>

          <div class="accordion-item" *ngIf="aluno.necessidadesRelatoriosMedicos && aluno.necessidadesRelatoriosMedicos.trim() !== ''">
             <h2 class="accordion-header" id="headingNecessidades">
               <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNecessidades" aria-expanded="false" aria-controls="collapseNecessidades">
                Necessidades (Relatórios Médicos)
               </button>
             </h2>
             <div id="collapseNecessidades" class="accordion-collapse collapse" aria-labelledby="headingNecessidades" data-bs-parent="#naapiAccordion">
               <div class="accordion-body info-content">
                 {{ aluno.necessidadesRelatoriosMedicos }}
               </div>
             </div>
          </div>

          <div class="accordion-item" *ngIf="aluno.anotacoesNaapi && aluno.anotacoesNaapi.trim() !== ''">
             <h2 class="accordion-header" id="headingAnotacoes">
               <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnotacoes" aria-expanded="false" aria-controls="collapseAnotacoes">
                Anotações Gerais (NAAPI)
               </button>
             </h2>
             <div id="collapseAnotacoes" class="accordion-collapse collapse" aria-labelledby="headingAnotacoes" data-bs-parent="#naapiAccordion">
               <div class="accordion-body info-content">
                 {{ aluno.anotacoesNaapi }}
               </div>
             </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingAtendimentos">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAtendimentos" aria-expanded="true" aria-controls="collapseAtendimentos">
                Histórico de Atendimentos
              </button>
            </h2>
            <div id="collapseAtendimentos" class="accordion-collapse collapse show" aria-labelledby="headingAtendimentos" data-bs-parent="#naapiAccordion">
              <div class="accordion-body">
                <div class="list-section-header">
                  <h5 class="list-title-sub">Registros</h5>
                  <button class="btn btn-success btn-sm"
                          data-bs-toggle="modal" data-bs-target="#modalAtendimento">
                    <i class="bi bi-plus-lg"></i> Novo
                  </button>
                </div>
                <app-atendimento-list [alunoId]="aluno.id"></app-atendimento-list>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingLaudos">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLaudos" aria-expanded="false" aria-controls="collapseLaudos">
                Laudos e Documentos
              </button>
            </h2>
            <div id="collapseLaudos" class="accordion-collapse collapse" aria-labelledby="headingLaudos" data-bs-parent="#naapiAccordion">
              <div class="accordion-body">
                 <div class="list-section-header">
                   <h5 class="list-title-sub">Documentos Anexados</h5>
                   <button class="btn btn-success btn-sm"
                           data-bs-toggle="modal" data-bs-target="#modalLaudo">
                     <i class="bi bi-plus-lg"></i> Novo Laudo
                   </button>
                 </div>
                 <app-laudo-list [alunoId]="aluno.id"></app-laudo-list>
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingPei">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePei" aria-expanded="false" aria-controls="collapsePei">
                Plano Educacional (PEI)
              </button>
            </h2>
            <div id="collapsePei" class="accordion-collapse collapse" aria-labelledby="headingPei" data-bs-parent="#naapiAccordion">
              <div class="accordion-body">
                <div class="list-section-header" *ngIf="canEditPei$ | async">
                   <h5 class="list-title-sub">Planos Registrados</h5>
                   <button class="btn btn-success btn-sm"
                           data-bs-toggle="modal" data-bs-target="#modalPei">
                     <i class="bi bi-plus-lg"></i> Novo PEI
                   </button>
                 </div>
                <app-pei-list [alunoId]="aluno.id"></app-pei-list>
              </div>
            </div>
          </div>
          </div>

        <div class="info-section mt-5 d-grid">
          <a [routerLink]="['/alunos/editar', aluno.id]" class="btn btn-primary btn-lg">
            <i class="bi bi-pencil-fill me-2"></i> Editar Cadastro Completo
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalAtendimento" tabindex="-1" aria-labelledby="modalAtendimentoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <app-atendimento-form
      *ngIf="alunoId"
      [alunoId]="alunoId"
      (atendimentoSalvo)="onAtendimentoSalvo()">
    </app-atendimento-form>
  </div>
</div>

<div class="modal fade" id="modalLaudo" tabindex="-1" aria-labelledby="modalLaudoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <app-laudo-form
      *ngIf="alunoId"
      [alunoId]="alunoId"
      (laudoSalvo)="onLaudoSalvo()">
    </app-laudo-form>
  </div>
</div>

<div class="modal fade" id="modalPei" tabindex="-1" aria-labelledby="modalPeiLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <app-pei-form
      *ngIf="alunoId"
      [alunoId]="alunoId"
      (peiSalvo)="onPeiSalvo()">
    </app-pei-form>
  </div>
</div>
