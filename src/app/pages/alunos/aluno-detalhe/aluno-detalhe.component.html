<ng-template #loading>
  <div class="d-flex justify-content-center mt-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Carregando dados do aluno...</span>
    </div>
  </div>
</ng-template>

<div class="aluno-detalhe-page" *ngIf="aluno$ | async as aluno; else loading">
  <div class="row g-0">

    <div class="col-lg-5">
      <div class="aluno-foto-container">
        <img [src]="aluno.foto || 'https://via.placeholder.com/600x800.png?text=FOTO DO ALUNO'"
             alt="Foto do Aluno"
             class="aluno-foto-principal">
      </div>
    </div>

    <div class="col-lg-7">
      <div class="aluno-info-container">

        <div class="info-section">
          <h2 class="aluno-nome">{{ aluno.nome }}</h2>
          <p *ngIf="aluno.nomeSocial" class="aluno-nome-social">({{ aluno.nomeSocial }})</p>
          <p class="aluno-matricula">{{ aluno.matricula }} | {{ aluno.curso.nome }}</p>
        </div>

        <div class="info-section d-grid">
          <a [routerLink]="['/alunos/editar', aluno.id]" class="btn btn-primary btn-lg">
            <i class="bi bi-pencil-fill me-2"></i> Editar Cadastro
          </a>
        </div>

        <div class="info-section stacked-info-container">
          <div class="info-item">
            <span class="info-label">Prioridade</span>
            <span class="badge" [ngClass]="{
              'text-bg-danger': aluno.prioridade === 'Alta',
              'text-bg-warning': aluno.prioridade === 'Média',
              'text-bg-success': aluno.prioridade === 'Baixa'
            }">
              {{ aluno.prioridade }}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Prova Separada</span>
            <span class="badge" [ngClass]="aluno.provaOutroEspaco ? 'text-bg-info' : 'text-bg-secondary'">
              {{ aluno.provaOutroEspaco ? 'Sim' : 'Não' }}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">CPF</span>
            <span class="info-value">{{ (aluno.cpf | slice:0:3) + '.***.***-**' || 'Não informado' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Data Nasc.</span>
            <span class="info-value">{{ (aluno.dataNascimento | date: 'dd/MM/yyyy') || 'Não informada' }}</span>
          </div>
        </div>

        <hr class="section-divider">

        <div class="accordion accordion-flush hering-accordion" id="naapiAccordion">

          <div class="accordion-item" *ngIf="aluno.adaptacoesNecessarias">
            <h2 class="accordion-header" id="headingAdaptacoes">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdaptacoes" aria-expanded="false" aria-controls="collapseAdaptacoes">
                Adaptações Necessárias
              </button>
            </h2>
            <div id="collapseAdaptacoes" class="accordion-collapse collapse" aria-labelledby="headingAdaptacoes" data-bs-parent="#naapiAccordion">
              <div class="accordion-body info-content">
                 {{ aluno.adaptacoesNecessarias }}
              </div>
            </div>
          </div>

          <div class="accordion-item" *ngIf="aluno.necessidadesRelatoriosMedicos">
             <h2 class="accordion-header" id="headingNecessidades">
               <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNecessidades" aria-expanded="false" aria-controls="collapseNecessidades">
                Necessidades (Relatórios Médicos)
               </button>
             </h2>
             <div id="collapseNecessidades" class="accordion-collapse collapse" aria-labelledby="headingNecessidades" data-bs-parent="#naapiAccordion">
               <div class="accordion-body info-content">
                 {{ aluno.necessidadesRelatoriosMedicos }}
               </div>
             </div>
          </div>

          <div class="accordion-item" *ngIf="aluno.anotacoesNaapi">
             <h2 class="accordion-header" id="headingAnotacoes">
               <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnotacoes" aria-expanded="false" aria-controls="collapseAnotacoes">
                Anotações Gerais (NAAPI)
               </button>
             </h2>
             <div id="collapseAnotacoes" class="accordion-collapse collapse" aria-labelledby="headingAnotacoes" data-bs-parent="#naapiAccordion">
               <div class="accordion-body info-content">
                 {{ aluno.anotacoesNaapi }}
               </div>
             </div>
          </div>

          <hr class="section-divider">

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingAtendimentos">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAtendimentos" aria-expanded="true" aria-controls="collapseAtendimentos">
                Histórico de Atendimentos
              </button>
            </h2>
            <div id="collapseAtendimentos" class="accordion-collapse collapse show" aria-labelledby="headingAtendimentos" data-bs-parent="#naapiAccordion">
              <div class="accordion-body">
                <div class="list-section-header">
                  <h5 class="list-title-sub">Registros</h5>
                  <button class="btn btn-success btn-sm"
                          data-bs-toggle="modal" data-bs-target="#modalAtendimento">
                    <i class="bi bi-plus-lg"></i> Novo
                  </button>
                </div>
                <app-atendimento-list [alunoId]="aluno.id"></app-atendimento-list>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingLaudos">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLaudos" aria-expanded="false" aria-controls="collapseLaudos">
                Laudos
              </button>
            </h2>
            <div id="collapseLaudos" class="accordion-collapse collapse" aria-labelledby="headingLaudos" data-bs-parent="#naapiAccordion">
              <div class="accordion-body">
                 <app-laudo-list [alunoId]="aluno.id"></app-laudo-list>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingPei">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePei" aria-expanded="false" aria-controls="collapsePei">
                Plano Educacional (PEI)
              </button>
            </h2>
            <div id="collapsePei" class="accordion-collapse collapse" aria-labelledby="headingPei" data-bs-parent="#naapiAccordion">
              <div class="accordion-body">
                <app-pei-list [alunoId]="aluno.id"></app-pei-list>
              </div>
            </div>
          </div>

        </div> </div> </div> </div> </div> <div class="modal fade" id="modalAtendimento" tabindex="-1" aria-labelledby="modalAtendimentoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <app-atendimento-form
      *ngIf="alunoId"
      [alunoId]="alunoId"
      (atendimentoSalvo)="onAtendimentoSalvo()">
    </app-atendimento-form>
  </div>
</div>
