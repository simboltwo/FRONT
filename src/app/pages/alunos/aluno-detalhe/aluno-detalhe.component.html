<div class="container-fluid" *ngIf="aluno$ | async as aluno; else loading">

  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <img [src]="aluno.foto || 'https://via.placeholder.com/80.png?text=Aluno'"
             alt="Foto do Aluno"
             class="rounded-circle me-3 profile-photo-detail">
        <div>
          <h2 class="h4 mb-0">{{ aluno.nome }}</h2>
          <span *ngIf="aluno.nomeSocial" class="text-muted fs-6"> ({{ aluno.nomeSocial }})</span>
          <p class="mb-0 text-muted">{{ aluno.matricula }} | {{ aluno.curso.nome }}</p>
        </div>
      </div>
      <div class="mt-2 mt-md-0">
        <a [routerLink]="['/alunos/editar', aluno.id]" class="btn btn-primary">
          <i class="bi bi-pencil-fill me-1"></i> Editar Cadastro
        </a>
      </div>
    </div>
    <div class="card-body">
      <div class="row gy-3">
        <div class="col-md-3 col-6">
          <strong>Prioridade:</strong>
          <span class="badge ms-2" [ngClass]="{
            'text-bg-danger': aluno.prioridade === 'Alta',
            'text-bg-warning': aluno.prioridade === 'Média',
            'text-bg-success': aluno.prioridade === 'Baixa'
          }">
            {{ aluno.prioridade }}
          </span>
        </div>
        <div class="col-md-3 col-6">
          <strong>Prova Separada:</strong>
          <span class="badge" [ngClass]="aluno.provaOutroEspaco ? 'text-bg-info' : 'text-bg-secondary'">
            {{ aluno.provaOutroEspaco ? 'Sim' : 'Não' }}
          </span>
        </div>
        <div class="col-md-3 col-6">
          <strong>CPF:</strong> {{ (aluno.cpf | slice:0:3) + '.***.***-**' || 'Não informado' }}
        </div>
        <div class="col-md-3 col-6">
          <strong>Data Nasc:</strong> {{ aluno.dataNascimento | date: 'dd/MM/yyyy' }}
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" id="naapiTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="atendimentos-tab" data-bs-toggle="tab" data-bs-target="#atendimentos" type="button" role="tab">
            <i class="bi bi-calendar-check me-1"></i> Atendimentos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="laudos-tab" data-bs-toggle="tab" data-bs-target="#laudos" type="button" role="tab">
            <i class="bi bi-file-earmark-medical me-1"></i> Laudos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pei-tab" data-bs-toggle="tab" data-bs-target="#pei" type="button" role="tab">
            <i class="bi bi-clipboard2-data me-1"></i> PEI
          </button>
        </li>
      </ul>
    </div>

    <div class="card-body tab-content" id="naapiTabsContent">

      <div class="tab-pane fade show active" id="atendimentos" role="tabpanel">

        <div class="d-flex justify-content-end mb-3">
          <button class="btn btn-success btn-sm"
                  data-bs-toggle="modal" data-bs-target="#modalAtendimento">
            <i class="bi bi-plus-lg"></i>
            Novo Atendimento
          </button>
        </div>

        <app-atendimento-list [alunoId]="aluno.id"></app-atendimento-list>
      </div>

      <div class="tab-pane fade" id="laudos" role="tabpanel">
        <app-laudo-list [alunoId]="aluno.id"></app-laudo-list>
      </div>

      <div class="tab-pane fade" id="pei" role="tabpanel">
        <app-pei-list [alunoId]="aluno.id"></app-pei-list>
      </div>

    </div>
  </div>
</div>

<ng-template #loading>
  <div class="d-flex justify-content-center mt-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Carregando dados do aluno...</span>
    </div>
  </div>
</ng-template>


<div class="modal fade" id="modalAtendimento" tabindex="-1" aria-labelledby="modalAtendimentoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <app-atendimento-form
      *ngIf="alunoId"
      [alunoId]="alunoId"
      (atendimentoSalvo)="onAtendimentoSalvo()">
    </app-atendimento-form>
  </div>
</div>
